name: IAM Cognito Terminal Unblock

on:
  workflow_dispatch:
    inputs:
      role_name:
        description: "Deploy role to patch with Cognito + SecretsManager permissions"
        type: string
        required: false
        default: "enceladus-backend-deploy-github-role"
      reason:
        description: "Why this hotfix is needed"
        type: string
        required: false
        default: "Unblock ENC-ISS-076 Cognito terminal agent credential provisioning"

permissions:
  contents: read
  id-token: write

jobs:
  patch-role:
    name: Patch deploy role for Cognito terminal provisioning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_BACKEND_ROLE_TO_ASSUME }}
          aws-region: us-west-2

      - name: Verify caller identity
        run: aws sts get-caller-identity

      - name: Apply Cognito + SecretsManager inline policy
        env:
          ROLE_NAME: ${{ github.event.inputs.role_name }}
        run: |
          set -euo pipefail
          cat > /tmp/enceladus-cognito-terminal-policy.json <<'JSON'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "CognitoTerminalAgentProvisioning",
                "Effect": "Allow",
                "Action": [
                  "cognito-idp:DescribeUserPoolClient",
                  "cognito-idp:UpdateUserPoolClient",
                  "cognito-idp:AdminCreateUser",
                  "cognito-idp:AdminGetUser",
                  "cognito-idp:AdminSetUserPassword"
                ],
                "Resource": "arn:aws:cognito-idp:us-east-1:356364570033:userpool/us-east-1_b2D0V3E1k"
              },
              {
                "Sid": "SecretsManagerTerminalAgentProvisioning",
                "Effect": "Allow",
                "Action": [
                  "secretsmanager:DescribeSecret",
                  "secretsmanager:CreateSecret",
                  "secretsmanager:PutSecretValue"
                ],
                "Resource": "arn:aws:secretsmanager:us-west-2:356364570033:secret:devops/coordination/*"
              }
            ]
          }
          JSON

          aws iam put-role-policy \
            --role-name "${ROLE_NAME}" \
            --policy-name "enceladus-cognito-terminal-provisioning-v1" \
            --policy-document "file:///tmp/enceladus-cognito-terminal-policy.json"

      - name: Verify inline policy attached
        env:
          ROLE_NAME: ${{ github.event.inputs.role_name }}
        run: |
          set -euo pipefail
          aws iam get-role-policy \
            --role-name "${ROLE_NAME}" \
            --policy-name "enceladus-cognito-terminal-provisioning-v1" \
            --query '{RoleName:RoleName,PolicyName:PolicyName}' \
            --output table
