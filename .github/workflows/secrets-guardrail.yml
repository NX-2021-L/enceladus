name: Secrets Guardrail

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: "17 8 * * *"
  workflow_dispatch:
    inputs:
      scan_remote:
        description: "Also scan public GitHub repo URL"
        type: boolean
        required: true
        default: true

permissions:
  contents: read

jobs:
  secrets-scan:
    name: Secrets Scan (History + Filesystem)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          set -euo pipefail
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin
          trufflehog --version

      - name: Run local guard scans
        run: |
          set -euo pipefail
          chmod +x tools/secrets_guard.sh
          tools/secrets_guard.sh

      - name: Run remote public GitHub scan
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.scan_remote == 'true')
        env:
          SCAN_REMOTE: "1"
          REMOTE_REPO_URL: https://github.com/${{ github.repository }}.git
        run: |
          set -euo pipefail
          tools/secrets_guard.sh
